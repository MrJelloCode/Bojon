<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bojon Lobby</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
  <style>
    :root {
      --gold: #d4af37;
      --black: #0b0b0b;
      --gray: #222;
      --text-light: #f0f0f0;
    }

    body {
      margin: 0;
      padding: 2rem;
      font-family: 'Orbitron', sans-serif;
      background-color: var(--black);
      color: var(--gold);
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: auto 3fr auto;
      grid-template-areas:
        "stats welcome"
        "main leaderboard"
        "logout leaderboard";
      gap: 1rem;
      height: 100vh;
      box-sizing: border-box;
    }

    .box {
      background-color: var(--gray);
      border: 2px solid var(--gold);
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      flex-direction: column;
    }

    #userStats {
      grid-area: stats;
      font-size: 1.6rem;
    }

    #eloValue {
      font-size: 2.8rem;
      font-weight: bold;
      color: var(--text-light);
      margin-top: 0.5rem;
    }

    #welcome {
      grid-area: welcome;
      font-size: 1.8rem;
    }

    #main {
      grid-area: main;
      display: flex;
      gap: 1rem;
    }

    #findBattle, #help {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1.5rem;
      line-height: 1.75rem;
    }

    h2 {
      color: var(--gold);
    }

    p {
      color: var(--text-light);
      font-size: 1rem;
    }

    #findBattle button, #logout button {
      background-color: var(--gold);
      color: var(--black);
      font-weight: bold;
      padding: 1em 2em;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    #leaderboard {
      grid-area: leaderboard;
      display: flex;
      flex-direction: column;
    }

    #logout {
      grid-area: logout;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div id="userStats" class="box">
    üß† Your ELO
    <div id="eloValue">Loading...</div>
  </div>
  <div id="welcome" class="box">Welcome, <span id="username"> loading...</span>!</div>
  <div id="main">
    <div id="findBattle" class="box">
      <div>
        <h2>üöÄ Start Your Interview Duel</h2>
        <p>Test your skills by going head-to-head against another user in a 1v1 mock interview. You'll both receive the same question and have 20 seconds to respond. Our AI scores your answer in real-time and updates your ELO accordingly.</p>
      </div>
      <button onclick=startMatchmaking()>üîç Find a Battle</button>
    </div>
    <div id="help" class="box">
      <div>
        <h2>üìò How It Works</h2>
        <p>Bojon is a 1v1 real-time interview simulator where you and another player answer the same interview question. Your responses are scored by AI, and you earn ELO points based on how well you perform. Climb the leaderboard, get instant feedback, and sharpen your communication skills with every battle.</p>
      </div>
    </div>
  </div>
  <div id="leaderboard" class="box">
    <h3>üèÜ TOP 10 LEADERBOARD</h3>
    <ul id="topPlayers" style="list-style: none; padding: 0; color: var(--text-light);"></ul>
  </div>
  <div id="logout" class="box">
    <button id="logoutBtn">üö™ Thank you for playing! (Log out)</button>
  </div>

  <script>
    let auth0 = null;

    async function startMatchmaking() {
      const username = document.getElementById('username').textContent.trim();
      const response = await fetch(`/auto-match?username=${encodeURIComponent(username)}`);
      const data = await response.json();

      if (data.opponent) {
        alert(`Match found! Opponent: ${data.opponent}`);
        window.location.href = "/games.html";
      } else {
        alert('No match found. Please try again later.');
      }
    }

    async function configureAuth0() {
      auth0 = await createAuth0Client({
        domain: 'bojon.ca.auth0.com',
        client_id: 'hxZOfc9vWXe0flKNTKaTXXPOJGzwpIj1',
        cacheLocation: 'localstorage'
      });

      const isAuthenticated = await auth0.isAuthenticated();

      if (isAuthenticated) {
        const user = await auth0.getUser();
        const username = user.nickname || user.name || user.email || 'Guest';
        document.getElementById('username').textContent = '\u00A0' + username;

        fetch(`/get-elo?username=${encodeURIComponent(username)}`)
          .then(res => res.json())
          .then(data => {
            window.currentElo = data.elo;
            document.getElementById('eloValue').textContent = data.elo;

            fetch('/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user, elo: data.elo })
            });
          });

        fetch('/leaderboard')
          .then(res => res.json())
          .then(data => {
            const ul = document.getElementById('topPlayers');
            ul.innerHTML = '';
            data.forEach((player, i) => {
              const li = document.createElement('li');
              li.textContent = `${i + 1}. ${player.name || player.email || 'Player'} - ${player.elo}`;
              ul.appendChild(li);
            });
          });

      } else {
        await auth0.loginWithRedirect({ redirect_uri: window.location.href });
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        auth0.logout({ returnTo: "/index.html" });
      });
    }

    window.onload = configureAuth0;
  </script>
</body>
</html>
